name: Auto Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is-new-version: ${{ steps.version.outputs.is-new-version }}
      release-notes: ${{ steps.changelog.outputs.release-notes }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Extract Version
      id: version
      run: |
        # ä»Ž main.go ä¸­æå–ç‰ˆæœ¬å·
        VERSION=$(grep -o 'var Version = "[^"]*"' main.go | sed 's/var Version = "\(.*\)"/\1/')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦ä¸ºæ–°ç‰ˆæœ¬ï¼ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥tagï¼‰
        if git tag -l "v$VERSION" | grep -q "v$VERSION"; then
          echo "is-new-version=false" >> $GITHUB_OUTPUT
          echo "Version v$VERSION already exists, skipping release creation"
        else
          echo "is-new-version=true" >> $GITHUB_OUTPUT
          echo "New version v$VERSION detected, will create release"
        fi
        
        echo "Current version: $VERSION"
    
    - name: Generate Release Notes
      id: changelog
      if: steps.version.outputs.is-new-version == 'true'
      run: |
        VERSION=${{ steps.version.outputs.version }}
        
        # èŽ·å–ä»Žä¸Šä¸€ä¸ªç‰ˆæœ¬åˆ°çŽ°åœ¨çš„æ‰€æœ‰ commit
        if git tag -l | grep -q "v"; then
          # æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬æ ‡ç­¾
          PREV_TAG=$(git tag -l "v*" | sort -V | tail -n 2 | head -n 1)
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%h %s" $PREV_TAG..HEAD)
          else
            COMMITS=$(git log --pretty=format:"%h %s" --reverse)
          fi
        else
          COMMITS=$(git log --pretty=format:"%h %s" --reverse)
        fi
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž
        cat > release-notes.md << EOF
        ## Process Tracker v$VERSION
        
        ðŸš€ **æ™ºèƒ½è¿›ç¨‹ç›‘æŽ§å·¥å…·** - ç”¨äºŽè·Ÿè¸ªå’Œåˆ†æžç³»ç»Ÿè¿›ç¨‹çš„èµ„æºä½¿ç”¨æƒ…å†µ
        
        ### ðŸ“¦ ä¸‹è½½
        
        é€‰æ‹©é€‚åˆæ‚¨å¹³å°çš„ç‰ˆæœ¬ï¼š
        
        - **process-tracker-linux-amd64** - Linux Intel/AMD 64ä½
        - **process-tracker-linux-arm64** - Linux ARM 64ä½
        - **process-tracker-macos-amd64** - macOS Intel 64ä½
        - **process-tracker-macos-arm64** - macOS ARM64 (Apple Silicon)
        - **process-tracker-windows-amd64.exe** - Windows Intel/AMD 64ä½
        
        ### ðŸš€ å¿«é€Ÿå¼€å§‹
        
        \`\`\`bash
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x process-tracker-*
        
        # å¼€å§‹ç›‘æŽ§
        ./process-tracker-linux-amd64 start
        
        # æŸ¥çœ‹ç‰ˆæœ¬
        ./process-tracker-linux-amd64 version
        
        # æŸ¥çœ‹å¸®åŠ©
        ./process-tracker-linux-amd64 help
        \`\`\`
        
        ### ðŸ“‹ æœ¬æ¬¡æ›´æ–°å†…å®¹
        
        $COMMITS
        
        ### âœ¨ ä¸»è¦ç‰¹æ€§
        
        - ðŸ” **å®žæ—¶ç›‘æŽ§**: ç›‘æŽ§CPUã€å†…å­˜ã€ç£ç›˜I/Oã€ç½‘ç»œä½¿ç”¨æƒ…å†µ
        - ðŸ“Š **æ™ºèƒ½ç»Ÿè®¡**: æ”¯æŒç®€å•ã€è¯¦ç»†ã€å®Œæ•´ä¸‰ç§ç»Ÿè®¡ç²’åº¦
        - ðŸ—‚ï¸ **æ™ºèƒ½åˆ†ç±»**: è‡ªåŠ¨è¯†åˆ«åº”ç”¨ç¨‹åºç±»åž‹
        - ðŸ’¾ **å­˜å‚¨ä¼˜åŒ–**: è‡ªåŠ¨æ–‡ä»¶è½®è½¬å’ŒåŽ‹ç¼©
        - ðŸŽ›ï¸ **çµæ´»é…ç½®**: YAMLé…ç½®æ–‡ä»¶æ”¯æŒ
        - ðŸ“¤ **æ•°æ®å¯¼å‡º**: JSONæ ¼å¼æ•°æ®å¯¼å‡ºå’Œåˆ†æž
        
        ### ðŸ“„ å®Œæ•´æ–‡æ¡£
        
        è¯¦ç»†ä½¿ç”¨è¯´æ˜Žè¯·å‚è€ƒï¼š[README.md](https://github.com/yourusername/process-tracker/blob/main/README.md)
        
        ---
        
        ðŸ¤– *æ­¤å‘å¸ƒç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
        EOF
        
        echo "Release notes generated:"
        cat release-notes.md
        
        # å°† release notes å†…å®¹æ·»åŠ åˆ°è¾“å‡º
        echo "release-notes<<EOF" >> $GITHUB_OUTPUT
        cat release-notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

  build:
    needs: version-check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        goarch: [amd64]
        include:
          - os: ubuntu-latest
            goarch: arm64
          - os: macos-latest
            goarch: arm64
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
    
    - name: Build for ${{ matrix.os }}/${{ matrix.goarch }}
      env:
        GOOS: ${{ matrix.os == 'ubuntu-latest' && 'linux' || (matrix.os == 'macos-latest' && 'darwin' || 'windows') }}
        GOARCH: ${{ matrix.goarch }}
        VERSION: ${{ needs.version-check.outputs.version }}
      shell: bash
      run: |
        # è®¾ç½®è¾“å‡ºæ–‡ä»¶å
        if [ "$GOOS" = "windows" ]; then
          OUTPUT_NAME="process-tracker.exe"
        elif [ "$GOOS" = "darwin" ]; then
          if [ "$GOARCH" = "arm64" ]; then
            OUTPUT_NAME="process-tracker-macos-arm64"
          else
            OUTPUT_NAME="process-tracker-macos"
          fi
        else
          if [ "$GOARCH" = "arm64" ]; then
            OUTPUT_NAME="process-tracker-linux-arm64"
          else
            OUTPUT_NAME="process-tracker"
          fi
        fi
        
        # æž„å»ºç¨‹åº
        go build -ldflags="-X main.Version=$VERSION" -o "$OUTPUT_NAME" .
        
        echo "Built: $OUTPUT_NAME"
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -la "$OUTPUT_NAME"
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: process-tracker-${{ matrix.os }}-${{ matrix.goarch }}
        path: |
          process-tracker*
          process-tracker.exe*

  create-release:
    needs: [version-check, build]
    runs-on: ubuntu-latest
    if: needs.version-check.outputs.is-new-version == 'true'
    steps:
    - uses: actions/checkout@v4
    
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
    
    - name: Prepare Release Files
      env:
        VERSION: ${{ needs.version-check.outputs.version }}
      shell: bash
      run: |
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p release-files
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
        cat > release-files/release-notes.md << 'EOF'
        ${{ needs.version-check.outputs.release-notes }}
        EOF
        
        # é‡å‘½åå’Œæ•´ç†æ–‡ä»¶
        for dir in process-tracker-*; do
          if [ -d "$dir" ]; then
            echo "Processing directory: $dir"
            # æ‰¾åˆ°å¹¶ç§»åŠ¨æ–‡ä»¶
            find "$dir" -type f -exec cp {} release-files/ \;
          fi
        done
        
        # é‡å‘½åæ–‡ä»¶ä»¥åŒ…å«å¹³å°ä¿¡æ¯
        cd release-files
        for file in *; do
          if [ -f "$file" ] && [ "$file" != "release-notes.md" ]; then
            case "$file" in
              process-tracker.exe)
                # é‡å‘½å Windows å¯æ‰§è¡Œæ–‡ä»¶
                if [ "$file" != "process-tracker-windows-amd64.exe" ]; then
                  mv "$file" "process-tracker-windows-amd64.exe"
                fi
                ;;
              process-tracker-macos-arm64)
                # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¸éœ€è¦é‡å‘½å
                ;;
              process-tracker-macos)
                mv "$file" "process-tracker-macos-amd64"
                ;;
              process-tracker-linux-arm64)
                # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¸éœ€è¦é‡å‘½å
                ;;
              process-tracker)
                mv "$file" "process-tracker-linux-amd64"
                ;;
              process-tracker-windows-amd64.exe)
                # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¸éœ€è¦é‡å‘½å
                ;;
              process-tracker-macos-amd64)
                # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¸éœ€è¦é‡å‘½å
                ;;
              process-tracker-linux-amd64)
                # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¸éœ€è¦é‡å‘½å
                ;;
            esac
          fi
        done
        
        # æ¸…ç†é‡å¤æ–‡ä»¶ï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰
        for file in *; do
          if [ -f "$file" ] && [ "$file" != "release-notes.md" ]; then
            case "$file" in
              process-tracker.exe|process-tracker|process-tracker-macos|process-tracker-linux-arm64|process-tracker-macos-arm64)
                # åˆ é™¤åŽŸå§‹æ–‡ä»¶ï¼ˆå¦‚æžœé‡å‘½ååŽçš„æ–‡ä»¶å­˜åœ¨ï¼‰
                case "$file" in
                  process-tracker.exe)
                    if [ -f "process-tracker-windows-amd64.exe" ]; then
                      rm "$file"
                    fi
                    ;;
                  process-tracker)
                    if [ -f "process-tracker-linux-amd64" ]; then
                      rm "$file"
                    fi
                    ;;
                  process-tracker-macos)
                    if [ -f "process-tracker-macos-amd64" ]; then
                      rm "$file"
                    fi
                    ;;
                  process-tracker-linux-arm64)
                    # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¿ç•™
                    ;;
                  process-tracker-macos-arm64)
                    # å·²ç»æ˜¯æ­£ç¡®åç§°ï¼Œä¿ç•™
                    ;;
                esac
                ;;
            esac
          fi
        done
        
        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶
        echo "Release files:"
        ls -la
        
        # è®¡ç®—æ–‡ä»¶å¤§å°
        echo "File sizes:"
        for file in *; do
          if [ -f "$file" ] && [ "$file" != "release-notes.md" ]; then
            size=$(du -h "$file" | cut -f1)
            echo "  $file: $size"
          fi
        done
        
        # æ˜¾ç¤ºå‘å¸ƒè¯´æ˜Žé¢„è§ˆ
        echo ""
        echo "Release notes preview:"
        echo "================================"
        cat release-notes.md
        echo "================================"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.version-check.outputs.version }}
        name: Process Tracker v${{ needs.version-check.outputs.version }}
        body_path: release-files/release-notes.md
        files: |
          release-files/process-tracker-linux-amd64
          release-files/process-tracker-linux-arm64
          release-files/process-tracker-macos-amd64
          release-files/process-tracker-macos-arm64
          release-files/process-tracker-windows-amd64.exe
        draft: false
        prerelease: false
        generate_release_notes: false
    
    - name: Create Tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v${{ needs.version-check.outputs.version }}" -m "Release v${{ needs.version-check.outputs.version }}"
        git push origin "v${{ needs.version-check.outputs.version }}"
    
    - name: Summary
      run: |
        echo "ðŸŽ‰ Release v${{ needs.version-check.outputs.version }} created successfully!"
        echo "ðŸ“¦ Assets:"
        echo "  - Linux AMD64: process-tracker-linux-amd64"
        echo "  - Linux ARM64: process-tracker-linux-arm64"
        echo "  - macOS AMD64: process-tracker-macos-amd64"
        echo "  - macOS ARM64: process-tracker-macos-arm64"
        echo "  - Windows AMD64: process-tracker-windows-amd64.exe"